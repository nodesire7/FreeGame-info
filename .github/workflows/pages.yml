name: Build & Deploy (FreeGame-info)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Every 3 hours. GitHub cron uses UTC.
    - cron: "0 */3 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Prepare history store (branch: history)"
        shell: bash
        run: |
          set -e
          if git ls-remote --exit-code origin history >/dev/null 2>&1; then
            git fetch origin history:history
          else
            # first run: create local history branch from current HEAD
            git branch history
          fi
          git worktree add history-wt history
          mkdir -p history-wt/history/records

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright (Chromium)
        run: |
          python -m playwright install --with-deps chromium

      - name: Generate site
        run: |
          mkdir -p site
          python main.py site --history-dir history-wt/history
          touch site/.nojekyll

      - name: Persist history store (only when changed)
        shell: bash
        run: |
          set -e
          cd history-wt
          if [ -n "$(git status --porcelain history)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -f history
            git commit -m "Update history store"
            git push origin HEAD:history
          else
            echo "No history changes."
          fi

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

      # Releases: only on manual merge/push to main (NOT on schedule)
      - name: Compute next version tag
        if: github.event_name == 'push'
        id: version
        shell: bash
        run: |
          git fetch --tags --force
          latest="$(git tag -l 'v[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)"
          if [ -z "$latest" ]; then
            next="v1.0"
          else
            if [[ "$latest" =~ ^v([0-9]+)\.([0-9]+)$ ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              next="v${major}.$((minor+1))"
            else
              next="v1.0"
            fi
          fi
          echo "tag=$next" >> "$GITHUB_OUTPUT"
          echo "Next release tag: $next"

      - name: Package site for Release assets
        if: github.event_name == 'push'
        shell: bash
        run: |
          # Releases 用于“快速部署”，不打包最终生成页面
          rm -f deploy.zip deploy.tar.gz || true
          rm -f deploy/env || true
          cp deploy/env.example deploy/env
          # 写入本次版本号，用户开箱即用
          sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${{ steps.version.outputs.tag }}/" deploy/env
          zip -r deploy.zip deploy
          tar -czf deploy.tar.gz deploy

      - name: Create GitHub Release (merge builds only)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            deploy.zip
            deploy.tar.gz

      # Docker: only on merge/push to main
      - name: Set up Docker Buildx
        if: github.event_name == 'push'
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            nodesire77/game_info:latest
            nodesire77/game_info:${{ steps.version.outputs.tag }}


